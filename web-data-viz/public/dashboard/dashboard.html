<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>
    <link rel="stylesheet" href="./../css/dashboards.css">
    <link rel="shortcut icon" href="../assets/img/logo.png" type="image/x-icon">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../js/sessao.js"></script>
    <script src="./../js/alerta.js"></script>
</head>

<body onload="inicializarDashboard()">
    <div class="dashboard">
        <header class="top-bar">
            <div class="logo">🏃 Rundoɹd</div>
            <div class="date">11 de Junho</div>
            <div id="nome_usuario_dashboard" class="profile"></div>
        </header>

        <main class="content">
            <!-- Painel Esquerdo -->
            <section id="left_panel" class="left-panel">
                <h2 id="nome_da_Corrida">Corrida</h2>
                <div class="circle-stats" id="totalCorridas">0</div>
                <div class="stats">
                    <p>Distância: <strong id="ultimaDistancia">0 km</strong></p>
                    <p>Duração: <strong id="ultimoTempo">0</strong></p>
                    <p>Ritmo: <strong id="pace">0 min/km</strong></p>
                </div>
            </section>

            <!-- Painel Central - Gráfico -->
            <section class="map-panel">
                <div class="map-placeholder">
                    <canvas id="canva_grafico1"></canvas>
                </div>
                <div class="map-placeholder1">[ y = distancia | x = data ]</div>
            </section>

            <!-- Painel Direito -->
            <section class="right-panel">
                <h3>Feed</h3>
                <ul>
                    <li>✅ Atingiu 15k!</li>
                    <li>🏆 Posição do ranking nesta distância!</li>
                    <li>🏃 Pace geral excelente!</li>
                    <li>🔥 Total da semana: 33km</li>
                    <li>🔥 Top 3 do Quiz!</li>
                </ul>
                <button onclick="window.location='../perfil.html'">Voltar ao perfil</button>
            </section>
        </main>
    </div>

</body>

</html>

<script>
    window.onload = () => {
    inicializarDashboard();
    carregarCorridasParaGrafico(); // gráfico de pace
    carregarGraficoDistanciaPorData(); // gráfico de distância por data
};

    function inicializarDashboard() {
        document.getElementById("nome_usuario_dashboard").innerHTML = `${sessionStorage.NOME_USUARIO} ⬇`;
        dadosUltimaCorrida();
        carregarCorridasParaGrafico();
    }

    function tempoParaMinutos(tempoStr) {
        const partes = tempoStr.split(':');
        const horas = parseInt(partes[0], 10);
        const minutos = parseInt(partes[1], 10);
        const segundos = parseInt(partes[2], 10);

        return horas * 60 + minutos + segundos / 60;
    }

    function dadosUltimaCorrida() {
        fetch("/dashboard/dados_ultima_corrida", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ idServer: sessionStorage.ID_USUARIO })
        })
            .then(res => res.ok ? res.json() : Promise.reject("Erro no fetch"))
            .then(json => {
                const tempoEmMinutos = tempoParaMinutos(json.tempo);
                const distancia = parseFloat(json.distancia);
                let pace = 0;

                if (distancia > 0) {
                    pace = (tempoEmMinutos / distancia).toFixed(2);
                }

                left_panel.innerHTML = `
                <h2 id="nome_da_Corrida">${json.nome}</h2>
                <div class="circle-stats" id="totalCorridas">${json.qtdCorrida}</div>
                <div class="stats">
                    <p>Distância: <strong id="ultimaDistancia">${json.distancia}</strong></p>
                    <p>Duração: <strong id="ultimoTempo">${json.tempo}</strong></p>
                    <p>Ritmo: <strong id="pace">${pace} min/km</strong></p>
                </div>`;
            })
            .catch(err => console.error("Erro ao carregar dados da última corrida:", err));
    }

    function carregarCorridasParaGrafico() {
        fetch(`/dashboard/${sessionStorage.ID_USUARIO}`)
            .then(res => res.ok ? res.json() : Promise.reject("Erro no fetch"))
            .then(corridas => {
                if (!corridas.length) return;

                sessionStorage.setItem("Ultima_corrida", JSON.stringify(corridas));
                const labels = corridas.map(c => c.descricao);
                const data = corridas.map(c => {
                    const tempoMinutos = tempoParaMinutos(c.tempo);
                    return (tempoMinutos / parseFloat(c.distancia)).toFixed(2);
                });

                const chartData = {
                    labels: labels,
                    datasets: [{
                        label: "Pace (min/km)",
                        data: data,
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                };

                new Chart(document.getElementById('canva_grafico1'), {
                    type: 'bar',
                    data: chartData,
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            })
            .catch(erro => console.error("Erro ao carregar corridas:", erro));
    }


    function carregarGraficoDistanciaPorData() {
    fetch(`/corrida/dashboard/${sessionStorage.ID_USUARIO}`)
        .then(res => res.ok ? res.json() : Promise.reject("Erro no fetch"))
        .then(corridas => {
            if (!corridas.length) return;

            const labels = corridas.map(c => {
                const data = new Date(c.dtCorrida);
                return data.toLocaleDateString('pt-BR'); // ou use data.toISOString().split('T')[0];
            });

            const dataDistancias = corridas.map(c => parseFloat(c.distancia));

            const chartData = {
                labels: labels,
                datasets: [{
                    label: "Distância (km)",
                    data: dataDistancias,
                    backgroundColor: 'rgba(75, 192, 192, 0.5)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 2,
                    tension: 0.3
                }]
            };

            new Chart(document.getElementById('canva_grafico2'), {
                type: 'line', // ou "bar"
                data: chartData,
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Distância (km)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Data da Corrida'
                            }
                        }
                    }
                }
            });
        })
        .catch(erro => console.error("Erro ao carregar gráfico de distância:", erro));
}
</script>